<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fixeve レポート</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    font-family: "Arial", sans-serif;
    background-color: #ffffff;
    margin: 0;
    padding: 0;
    text-align: center;
  }

  h1 {
    margin-top: 20px;
    font-size: 28px;
    font-weight: bold;
  }

  .tab-container {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 20px 0;
  }

  .tab-button {
    padding: 10px 22px;
    font-size: 16px;
    border-radius: 6px;
    border: none;
    background-color: #ddd;
    cursor: pointer;
  }

  .tab-button.active {
    background-color: #4a90e2;
    color: white;
  }

  .view {
    display: none;
  }
  .view.active {
    display: block;
  }

  canvas {
    max-width: 90%;
    margin-top: 20px;
  }

  #detail-text {
    font-size: 18px;
    margin-top: 15px;
  }

  /* ホームボタン */
  #home-btn {
    display: inline-block;
    margin: 40px 0 30px;
    padding: 12px 30px;
    background-color: #4a90e2;
    color: white;
    border-radius: 8px;
    text-decoration: none;
    font-size: 18px;
  }

</style>
</head>
<body>

<h1>Fixeve レポート</h1>

<!-- タブ -->
<div class="tab-container">
  <button class="tab-button active" data-view="day">日</button>
  <button class="tab-button" data-view="week">週</button>
  <button class="tab-button" data-view="month">月</button>
  <button class="tab-button" data-view="year">年</button>
</div>

<p id="detail-text"></p>

<!-- ================= 日 ================= -->
<div id="view-day" class="view active">
  <canvas id="chart-day" width="350" height="300"></canvas>
</div>

<!-- ================= 週 ================= -->
<div id="view-week" class="view">
  <canvas id="chart-week" width="350" height="300"></canvas>
</div>

<!-- ================= 月 ================= -->
<div id="view-month" class="view">
  <input type="month" id="month-select" style="font-size:16px; padding:5px;">
  <canvas id="chart-month" width="350" height="300"></canvas>
</div>

<!-- ================= 年 ================= -->
<div id="view-year" class="view">
  <input type="number" id="year-input" value="2025" min="2000" max="2100"
         style="font-size:16px; padding:5px; width:120px;">
  <canvas id="chart-year" width="350" height="300"></canvas>
</div>

<!-- ホームへ戻る -->
<a id="home-btn" href="https://fixeve.github.io/fixeve-home/">ホームへ戻る</a>


<script>
/* ==============================
      共通：日付系関数
============================== */
function getTodayKey() {
  const now = new Date();
  const jst = new Date(now.getTime() + 9*60*60*1000);
  return jst.toISOString().slice(0, 10);
}

function getHourKey(dateKey, hour) {
  return `study_${dateKey}_${String(hour).padStart(2,"0")}`;
}

function getDateKey(date) {
  return date.toISOString().slice(0, 10);
}

/* ==============================
      データ取得
============================== */
function loadTodayHourly() {
  const key = getTodayKey();
  let arr = [];
  for (let h = 0; h < 24; h++) {
    const sec = parseInt(localStorage.getItem(getHourKey(key, h))) || 0;
    arr.push(sec / 60); // 分
  }
  return arr;
}

function loadDailyByDateKey(key) {
  const sec = parseInt(localStorage.getItem("study_" + key)) || 0;
  return Math.floor(sec / 60);
}

function loadWeekly() {
  let arr = [];
  const today = new Date();

  for (let i = 6; i >= 0; i--) {
    let d = new Date(today);
    d.setDate(d.getDate() - i);

    const key = getDateKey(new Date(d.getTime() + 9*60*60*1000));
    arr.push(loadDailyByDateKey(key));
  }
  return arr;
}

function loadMonthly(year, month) {
  let arr = [];
  const last = new Date(year, month, 0).getDate();

  for (let d = 1; d <= last; d++) {
    const key = `${year}-${String(month).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    arr.push(loadDailyByDateKey(key));
  }
  return arr;
}

function loadYearly(year) {
  let arr = [];
  for (let m = 1; m <= 12; m++) {
    let sum = 0;
    const last = new Date(year, m, 0).getDate();
    for (let d = 1; d <= last; d++) {
      const key = `${year}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
      sum += loadDailyByDateKey(key);
    }
    arr.push(sum);
  }
  return arr;
}

/* ==============================
      グラフ表示
============================== */
let chartDay, chartWeek, chartMonth, chartYear;

function renderDay() {
  const ctx = document.getElementById("chart-day").getContext("2d");
  const data = loadTodayHourly();

  if (chartDay) chartDay.destroy();
  chartDay = new Chart(ctx, {
    type: "bar",
    data: {
      labels: [...Array(24)].map((_,i)=>`${i}時`),
      datasets: [{ data }]
    },
    options: {
      onClick: (evt, item)=>{
        if (!item.length) return;
        const i = item[0].index;
        document.getElementById("detail-text").textContent =
          `${i}時台の勉強時間：${Math.floor(data[i])}分`;
      },
      scales: { y: { beginAtZero: true } }
    }
  });
}

function renderWeek() {
  const ctx = document.getElementById("chart-week").getContext("2d");
  const data = loadWeekly();

  if (chartWeek) chartWeek.destroy();
  chartWeek = new Chart(ctx, {
    type: "bar",
    data: {
      labels: ["6日前","5日前","4日前","3日前","2日前","昨日","今日"],
      datasets: [{ data }]
    },
    options: {
      onClick: (evt, item)=>{
        if (!item.length) return;
        const i = item[0].index;
        document.getElementById("detail-text").textContent =
          `${7-i}日前の勉強時間：${data[i]}分`;
      },
      scales: { y: { beginAtZero: true } }
    }
  });
}

function renderMonth() {
  const v = document.getElementById("month-select").value;
  if (!v) return;

  const [year, month] = v.split("-").map(n=>parseInt(n));
  const ctx = document.getElementById("chart-month").getContext("2d");
  const data = loadMonthly(year, month);

  if (chartMonth) chartMonth.destroy();
  chartMonth = new Chart(ctx, {
    type: "bar",
    data: {
      labels: data.map((_,i)=>`${i+1}日`),
      datasets: [{ data }]
    },
    options: {
      onClick: (evt,item)=>{
        if (!item.length) return;
        const i = item[0].index;
        document.getElementById("detail-text").textContent =
          `${i+1}日の勉強時間：${data[i]}分`;
      },
      scales: { y: { beginAtZero: true } }
    }
  });
}

function renderYear() {
  const year = parseInt(document.getElementById("year-input").value);
  const ctx = document.getElementById("chart-year").getContext("2d");
  const data = loadYearly(year);

  if (chartYear) chartYear.destroy();
  chartYear = new Chart(ctx, {
    type: "bar",
    data: {
      labels: [...Array(12)].map((_,i)=>`${i+1}月`),
      datasets: [{ data }]
    },
    options: {
      onClick: (evt,item)=>{
        if (!item.length) return;
        const i = item[0].index;
        document.getElementById("detail-text").textContent =
          `${i+1}月の勉強時間：${data[i]}分`;
      },
      scales: { y: { beginAtZero: true } }
    }
  });
}

/* ==============================
      タブ切替
============================== */
document.querySelectorAll(".tab-button").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".tab-button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");

    const target = btn.dataset.view;
    document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
    document.getElementById("view-"+target).classList.add("active");

    document.getElementById("detail-text").textContent = "";

    if (target==="day") renderDay();
    if (target==="week") renderWeek();
    if (target==="month") renderMonth();
    if (target==="year") renderYear();
  };
});

document.getElementById("month-select").onchange = renderMonth;
document.getElementById("year-input").onchange = renderYear;

/* 初回表示 */
renderDay();

</script>
</body>
</html>
