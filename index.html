<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fixeve レポート</title>
<style>
  body {
    font-family: "Hiragino Kaku Gothic ProN", sans-serif;
    background-color: #eef6ff;
    text-align: center;
    margin: 0;
    padding: 20px;
  }
  h1 {
    font-size: 28px;
    margin-bottom: 10px;
  }
  .mode-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 15px;
  }
  button {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    background-color: #007bff;
    color: white;
    font-size: 16px;
  }
  button:hover {
    background-color: #0056b3;
  }
  .arrow-buttons {
    margin-top: 10px;
  }
  .arrow-buttons button {
    background-color: #555;
    font-size: 18px;
  }
  canvas {
    background: white;
    border-radius: 10px;
    box-shadow: 0 0 10px #ccc;
    margin-top: 15px;
  }
  #home {
    display: block;
    margin-top: 25px;
    color: #007bff;
    font-weight: bold;
    text-decoration: none;
  }
</style>
</head>
<body>
  <h1>レポート</h1>
  <div class="mode-buttons">
    <button onclick="setMode('day')">日</button>
    <button onclick="setMode('week')">週</button>
    <button onclick="setMode('month')">月</button>
    <button onclick="setMode('year')">年</button>
  </div>

  <div class="arrow-buttons" id="navArrows" style="display:none;">
    <button onclick="changePeriod(-1)">←</button>
    <button onclick="changePeriod(1)">→</button>
  </div>

  <h2 id="title"></h2>
  <canvas id="chartCanvas" width="350" height="300"></canvas>

  <a id="home" href="https://fixeve.github.io/fixeve-home/">ホームに戻る</a>

<script>
const canvas = document.getElementById("chartCanvas");
const ctx = canvas.getContext("2d");
let mode = "day";
let currentDate = new Date();

function getStudyData() {
  return JSON.parse(localStorage.getItem("studyRecords") || "{}");
}

// ==== モード切り替え ====
function setMode(newMode) {
  mode = newMode;
  document.getElementById("navArrows").style.display = (mode === "day" || mode === "week") ? "none" : "block";
  drawChart();
}

// ==== 期間移動 ====
function changePeriod(offset) {
  if (mode === "month") {
    currentDate.setMonth(currentDate.getMonth() + offset);
  } else if (mode === "year") {
    currentDate.setFullYear(currentDate.getFullYear() + offset);
  }
  drawChart();
}

// ==== グラフ描画 ====
function drawChart() {
  const data = getStudyData();
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "#000";
  ctx.font = "16px Arial";

  if (mode === "day") {
    const todayKey = formatDate(currentDate);
    const total = data[todayKey] || 0;
    document.getElementById("title").textContent = `${todayKey} の勉強時間`;
    drawBars([{ label: todayKey, value: total }]);
  }

  if (mode === "week") {
    let days = [];
    for (let i = 6; i >= 0; i--) {
      let d = new Date(currentDate);
      d.setDate(d.getDate() - i);
      const key = formatDate(d);
      days.push({ label: key.slice(5), value: data[key] || 0 });
    }
    document.getElementById("title").textContent = `過去7日間の勉強時間`;
    drawBars(days);
  }

  if (mode === "month") {
    let year = currentDate.getFullYear();
    let month = currentDate.getMonth();
    let daysInMonth = new Date(year, month + 1, 0).getDate();
    let days = [];
    for (let i = 1; i <= daysInMonth; i++) {
      let key = `${year}-${String(month + 1).padStart(2,"0")}-${String(i).padStart(2,"0")}`;
      days.push({ label: i.toString(), value: data[key] || 0 });
    }
    document.getElementById("title").textContent = `${year}年${month + 1}月の勉強時間`;
    drawBars(days);
  }

  if (mode === "year") {
    let year = currentDate.getFullYear();
    let months = [];
    for (let i = 0; i < 12; i++) {
      let total = 0;
      for (let d = 1; d <= 31; d++) {
        let key = `${year}-${String(i+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
        total += data[key] || 0;
      }
      months.push({ label: `${i+1}月`, value: total });
    }
    document.getElementById("title").textContent = `${year}年の勉強時間`;
    drawBars(months);
  }
}

function drawBars(items) {
  const max = Math.max(...items.map(i => i.value), 1);
  const barWidth = (canvas.width - 40) / items.length;
  ctx.fillStyle = "#007bff";

  items.forEach((item, i) => {
    const x = 20 + i * barWidth;
    const h = (item.value / max) * 200;
    ctx.fillRect(x, 260 - h, barWidth - 5, h);
    ctx.fillStyle = "#000";
    ctx.fillText(item.label, x + barWidth/4, 280);
    ctx.fillText(formatTime(item.value), x + barWidth/6, 250 - h);
    ctx.fillStyle = "#007bff";
  });
}

function formatDate(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth()+1).padStart(2,"0");
  const d = String(date.getDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}

function formatTime(sec) {
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  return `${h}h${m}m`;
}

drawChart();
</script>
</body>
</html>
